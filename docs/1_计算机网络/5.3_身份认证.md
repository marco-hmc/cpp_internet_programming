---
layout: post
title: ï¼ˆå…­ï¼‰è®¡ç½‘é‚£äº›äº‹å„¿ï¼šåº”ç”¨å±‚-èº«ä»½è®¤è¯
categories: è®¡ç®—æœºç½‘ç»œ
related_posts: True
tags: network
toc:
  sidebar: right
---

## èº«ä»½è®¤è¯æœºåˆ¶ - å®‰å…¨çš„åŸºçŸ³


**æ ¸å¿ƒé—®é¢˜**: ç½‘ç»œæ˜¯å¼€æ”¾çš„ï¼Œå¦‚ä½•ç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·èƒ½è®¿é—®èµ„æºï¼Ÿ

```
å®‰å…¨å¨èƒï¼š
- æœªæˆæƒè®¿é—®ï¼šé™Œç”Ÿäººèƒ½çœ‹åˆ°ä½ çš„ç§äººä¿¡æ¯
- èº«ä»½å†’å……ï¼šåˆ«äººä¼ªè£…æˆä½ è¿›è¡Œæ“ä½œ
- æ•°æ®ç¯¡æ”¹ï¼šæ¶æ„ä¿®æ”¹é‡è¦æ•°æ®
- é‡æ”¾æ”»å‡»ï¼šæˆªè·å¹¶é‡å¤ä½¿ç”¨è®¤è¯ä¿¡æ¯

èº«ä»½è®¤è¯çš„ç›®æ ‡ï¼š
âœ… ç¡®è®¤ç”¨æˆ·èº«ä»½ (Authentication)
âœ… æˆæƒè®¿é—®æƒé™ (Authorization)
âœ… é˜²æ­¢èº«ä»½ç›—ç”¨
âœ… ä¿æŠ¤æ•æ„Ÿèµ„æº
```

### 1. ğŸª **Cookie + Session æ¨¡å¼**

#### **ä¼ ç»Ÿ Web è®¤è¯æµç¨‹**

```
1. ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨éªŒè¯ç”¨æˆ·åå¯†ç 
2. éªŒè¯æˆåŠŸ â†’ æœåŠ¡å™¨åˆ›å»ºSessionï¼Œè¿”å›Session ID
3. æµè§ˆå™¨å­˜å‚¨Session IDåˆ°Cookie
4. åç»­è¯·æ±‚ â†’ è‡ªåŠ¨æºå¸¦Cookieä¸­çš„Session ID
5. æœåŠ¡å™¨éªŒè¯Session ID â†’ ç¡®è®¤ç”¨æˆ·èº«ä»½

ä¼˜ç‚¹ï¼š
âœ… ç®€å•æ˜“å®ç°
âœ… æœåŠ¡å™¨ç«¯å¯æ§ (å¯ä»¥éšæ—¶æ’¤é”€Session)
âœ… å®‰å…¨æ€§è¾ƒå¥½ (Sessionæ•°æ®å­˜å‚¨åœ¨æœåŠ¡å™¨)

ç¼ºç‚¹ï¼š
âŒ æœåŠ¡å™¨éœ€è¦å­˜å‚¨Session (å†…å­˜/æ•°æ®åº“å‹åŠ›)
âŒ åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¤æ‚ (å¤šæœåŠ¡å™¨Sessionå…±äº«)
âŒ ç§»åŠ¨åº”ç”¨æ”¯æŒä¸å‹å¥½
```

#### **Session å®ç°ç¤ºä¾‹**

```python
from flask import Flask, session, request, jsonify
import uuid

app = Flask(__name__)
app.secret_key = 'your-secret-key'

# æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®åº“
users = {
    'admin': 'password123',
    'user1': 'mypassword'
}

@app.route('/login', methods=['POST'])
def login():
    data = request.get_json()
    username = data.get('username')
    password = data.get('password')

    # éªŒè¯ç”¨æˆ·åå¯†ç 
    if username in users and users[username] == password:
        # åˆ›å»ºSession
        session['user_id'] = username
        session['logged_in'] = True

        return jsonify({
            'status': 'success',
            'message': 'ç™»å½•æˆåŠŸ'
        })
    else:
        return jsonify({
            'status': 'error',
            'message': 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
        }), 401

@app.route('/protected')
def protected():
    # æ£€æŸ¥Session
    if session.get('logged_in'):
        return jsonify({
            'message': f'æ¬¢è¿ {session["user_id"]}',
            'data': 'è¿™æ˜¯å—ä¿æŠ¤çš„æ•°æ®'
        })
    else:
        return jsonify({'error': 'è¯·å…ˆç™»å½•'}), 401

@app.route('/logout')
def logout():
    session.clear()
    return jsonify({'message': 'å·²é€€å‡ºç™»å½•'})
```

### 2. ğŸ« **Token è®¤è¯æ¨¡å¼**

#### **æ— çŠ¶æ€è®¤è¯çš„ä¼˜åŠ¿**

```
Tokenè®¤è¯è§£å†³çš„é—®é¢˜ï¼š
1. åˆ†å¸ƒå¼æ‰©å±• - æ— éœ€Sessionå…±äº«
2. ç§»åŠ¨å‹å¥½ - ä¸ä¾èµ–Cookie
3. è·¨åŸŸæ”¯æŒ - å¯ä»¥æ”¾åœ¨Headerä¸­
4. å¾®æœåŠ¡æ¶æ„ - å„æœåŠ¡ç‹¬ç«‹éªŒè¯

JWT (JSON Web Token) ç»“æ„ï¼š
Header.Payload.Signature

ä¾‹å¦‚ï¼š
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

#### **JWT å®ç°ç¤ºä¾‹**

```python
import jwt
import datetime
from functools import wraps
from flask import Flask, request, jsonify

app = Flask(__name__)
SECRET_KEY = 'your-jwt-secret-key'

def generate_token(user_id):
    """ç”ŸæˆJWT Token"""
    payload = {
        'user_id': user_id,
        'exp': datetime.datetime.utcnow() + datetime.timedelta(hours=24),
        'iat': datetime.datetime.utcnow()
    }
    token = jwt.encode(payload, SECRET_KEY, algorithm='HS256')
    return token

def verify_token(token):
    """éªŒè¯JWT Token"""
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=['HS256'])
        return payload['user_id']
    except jwt.ExpiredSignatureError:
        return None  # Tokenè¿‡æœŸ
    except jwt.InvalidTokenError:
        return None  # Tokenæ— æ•ˆ

def token_required(f):
    """è£…é¥°å™¨ï¼šè¦æ±‚Tokenè®¤è¯"""
    @wraps(f)
    def decorated(*args, **kwargs):
        token = request.headers.get('Authorization')

        if not token:
            return jsonify({'error': 'ç¼ºå°‘Token'}), 401

        # ç§»é™¤ "Bearer " å‰ç¼€
        if token.startswith('Bearer '):
            token = token[7:]

        user_id = verify_token(token)
        if not user_id:
            return jsonify({'error': 'Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ'}), 401

        request.current_user = user_id
        return f(*args, **kwargs)

    return decorated

@app.route('/login', methods=['POST'])
def login():
    data = request.get_json()
    username = data.get('username')
    password = data.get('password')

    # éªŒè¯ç”¨æˆ·åå¯†ç  (ç®€åŒ–ç¤ºä¾‹)
    if username == 'admin' and password == 'password123':
        token = generate_token(username)
        return jsonify({
            'status': 'success',
            'token': token,
            'message': 'ç™»å½•æˆåŠŸ'
        })
    else:
        return jsonify({'error': 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'}), 401

@app.route('/protected')
@token_required
def protected():
    return jsonify({
        'message': f'æ¬¢è¿ {request.current_user}',
        'data': 'è¿™æ˜¯å—ä¿æŠ¤çš„æ•°æ®'
    })
```

### 3. ğŸ›¡ï¸ **å®‰å…¨å¨èƒä¸é˜²æŠ¤**

#### **CSRF æ”»å‡»ä¸é˜²æŠ¤**

```
CSRF (Cross-Site Request Forgery) æ”»å‡»åŸç†ï¼š

1. ç”¨æˆ·ç™»å½•é“¶è¡Œç½‘ç«™ Aï¼Œè·å¾—Cookie
2. ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™ B (åŒæ—¶ä¿æŒAçš„ç™»å½•çŠ¶æ€)
3. æ¶æ„ç½‘ç«™BåŒ…å«æŒ‡å‘é“¶è¡Œç½‘ç«™Açš„è¯·æ±‚
4. æµè§ˆå™¨è‡ªåŠ¨æºå¸¦Cookieï¼Œæ‰§è¡Œæ¶æ„æ“ä½œ

é˜²æŠ¤æªæ–½ï¼š
âœ… CSRF Token - è¡¨å•ä¸­åŒ…å«éšæœºToken
âœ… SameSite Cookie - é™åˆ¶è·¨ç«™Cookieå‘é€
âœ… éªŒè¯Referer - æ£€æŸ¥è¯·æ±‚æ¥æº
âœ… åŒé‡Cookie - éªŒè¯Cookieå’ŒHeaderä¸­çš„Token
```

#### **CSRF é˜²æŠ¤å®ç°**

```python
import secrets
from flask import Flask, session, request, render_template_string

app = Flask(__name__)
app.secret_key = 'your-secret-key'

def generate_csrf_token():
    """ç”ŸæˆCSRF Token"""
    if 'csrf_token' not in session:
        session['csrf_token'] = secrets.token_hex(16)
    return session['csrf_token']

def verify_csrf_token(token):
    """éªŒè¯CSRF Token"""
    return token == session.get('csrf_token')

@app.route('/form')
def show_form():
    csrf_token = generate_csrf_token()

    # ç®€åŒ–çš„HTMLæ¨¡æ¿
    template = '''
    <form method="POST" action="/transfer">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="text" name="amount" placeholder="è½¬è´¦é‡‘é¢">
        <input type="text" name="to_account" placeholder="æ”¶æ¬¾è´¦æˆ·">
        <button type="submit">è½¬è´¦</button>
    </form>
    '''
    return render_template_string(template, csrf_token=csrf_token)

@app.route('/transfer', methods=['POST'])
def transfer():
    # éªŒè¯CSRF Token
    csrf_token = request.form.get('csrf_token')
    if not verify_csrf_token(csrf_token):
        return 'éæ³•è¯·æ±‚ï¼', 403

    # å¤„ç†è½¬è´¦é€»è¾‘
    amount = request.form.get('amount')
    to_account = request.form.get('to_account')

    return f'è½¬è´¦ {amount} å…ƒåˆ° {to_account} æˆåŠŸï¼'
```
