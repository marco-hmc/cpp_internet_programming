---
layout: post
title: （四）计网那些事儿：网络层
categories: 计算机网络
related_posts: True
tags: network
toc:
  sidebar: right
---

## 网络层 (Network Layer) - 主机到主机的通信

- 理解网络层在网络中的作用和地位
- 掌握 IP 地址的概念、分类和应用
- 了解路由器的工作原理和路由选择
- 认识 ARP 协议和 ICMP 协议的作用
- 理解网络层的核心功能和实际应用

---

### 1. 网络层概述

#### 🔍 **什么是网络层？**

网络层是 OSI 模型的第三层，负责在不同网络之间传输数据包，实现**主机到主机**的通信。可以把它想象成：

- **邮政系统的分拣中心** - 根据地址将包裹送到正确的目的地
- **城市间的交通网络** - 规划从起点到终点的最佳路径
- **互联网的路由系统** - 在全球网络中寻找数据传输路径

#### 🎯 **主要功能**

| 功能           | 说明                           | 实际应用           |
| -------------- | ------------------------------ | ------------------ |
| **路径选择**   | 在多个可能的路径中选择最佳路径 | 路由算法、最短路径 |
| **逻辑寻址**   | 使用 IP 地址标识网络中的设备   | IPv4/IPv6 地址系统 |
| **数据包转发** | 将数据包从源主机传送到目标主机 | 路由器转发         |
| **拥塞控制**   | 管理网络流量，防止网络过载     | 流量控制算法       |
| **分片与重组** | 处理不同网络的 MTU 限制        | IP 分片机制        |

#### 🌐 **网络层在协议栈中的位置**

```
┌─────────────────┐
│   应用层        │ ← HTTP, FTP, DNS
├─────────────────┤
│   传输层        │ ← TCP, UDP
├─────────────────┤
│   网络层        │ ← IP, ICMP, ARP ⭐
├─────────────────┤
│   链路层        │ ← Ethernet, WiFi
├─────────────────┤
│   物理层        │ ← 物理传输介质
└─────────────────┘
```

---

### 2. IP 协议详解

#### 📍 **什么是 IP 地址？**

IP 地址（Internet Protocol Address）是网络层的核心，用于在全球范围内唯一标识网络设备。

##### **IP 地址的特点**

- **全局唯一性**: 在互联网上每个 IP 地址都是唯一的
- **分层结构**: 包含网络部分和主机部分
- **路由功能**: 支持数据包的路由转发
- **版本**: IPv4（32 位）和 IPv6（128 位）

#### 🔢 **IPv4 地址系统**

##### **地址格式**

```
IPv4地址: 192.168.1.100
二进制:   11000000.10101000.00000001.01100100
         ↑网络部分↑        ↑主机部分↑
```

##### **地址分类**

| 类别     | 范围                        | 网络数 | 主机数  | 应用场景 |
| -------- | --------------------------- | ------ | ------- | -------- |
| **A 类** | 1.0.0.0 - 126.255.255.255   | 126    | 1677 万 | 大型网络 |
| **B 类** | 128.0.0.0 - 191.255.255.255 | 16384  | 6.5 万  | 中型网络 |
| **C 类** | 192.0.0.0 - 223.255.255.255 | 209 万 | 254     | 小型网络 |

##### **特殊地址**

```bash
# 私有地址（RFC 1918）
10.0.0.0/8        # A类私有地址
172.16.0.0/12     # B类私有地址
192.168.0.0/16    # C类私有地址

# 特殊用途地址
127.0.0.1         # 本地回环地址
0.0.0.0           # 默认路由
255.255.255.255   # 广播地址
```

#### 📦 **IP 数据包结构**

![IP数据包结构](imgs/3_网络层_image.png)

##### **重要字段解析**

| 字段             | 长度  | 作用               | 实际意义                   |
| ---------------- | ----- | ------------------ | -------------------------- |
| **版本**         | 4 位  | 标识 IP 版本       | IPv4=4, IPv6=6             |
| **头部长度**     | 4 位  | IP 头部长度        | 最小 20 字节，最大 60 字节 |
| **总长度**       | 16 位 | 整个 IP 数据包长度 | 最大 65535 字节            |
| **TTL**          | 8 位  | 数据包生存时间     | 防止路由循环               |
| **协议**         | 8 位  | 上层协议类型       | TCP=6, UDP=17, ICMP=1      |
| **源 IP 地址**   | 32 位 | 发送方 IP 地址     | 标识发送主机               |
| **目标 IP 地址** | 32 位 | 接收方 IP 地址     | 标识目标主机               |

#### 🔧 **实际应用示例**

##### **查看本机 IP 配置**

```bash
# Linux/macOS
ifconfig
ip addr show

# Windows
ipconfig
ipconfig /all

# 查看路由表
route -n          # Linux
route print       # Windows
```

##### **IP 地址配置示例**

```bash
# 静态IP配置（Linux）
sudo ip addr add 192.168.1.100/24 dev eth0
sudo ip route add default via 192.168.1.1

# 查看网络连接
netstat -rn
ss -tuln
```

---

### 3. 子网划分与 CIDR

#### 🔀 **为什么需要子网划分？**

传统的分类地址分配造成大量 IP 地址浪费，子网划分和 CIDR 技术解决了这个问题。

##### **问题示例**

```
传统B类地址: 172.16.0.0
- 可容纳: 65534台主机
- 实际需要: 1000台主机
- 浪费: 64534个地址 ❌
```

#### 📊 **CIDR（无类别域间路由）**

##### **CIDR 表示法**

```
IP地址/前缀长度
例如: 192.168.1.0/24
     ↑IP地址  ↑网络位数
```

##### **子网掩码计算**

```
/24 = 255.255.255.0   (24个1)
/25 = 255.255.255.128 (25个1)
/26 = 255.255.255.192 (26个1)
/27 = 255.255.255.224 (27个1)
```

##### **实际应用案例**

```
企业网络规划:
总网络: 192.168.0.0/24

子网划分:
- 销售部门: 192.168.0.0/26   (64个地址)
- 技术部门: 192.168.0.64/26  (64个地址)
- 管理部门: 192.168.0.128/26 (64个地址)
- 预留网段: 192.168.0.192/26 (64个地址)
```

---

### 4. 路由与转发

#### 🛤️ **路由器的工作原理**

路由器是网络层的核心设备，负责在不同网络间转发数据包。

##### **路由器的主要功能**

```
数据包到达路由器
        ↓
检查目标IP地址
        ↓
查询路由表
        ↓
选择最佳路径
        ↓
转发到下一跳
```

##### **路由表结构**

```bash
# 查看路由表
route -n

目标网络        网关          掩码            接口
0.0.0.0         192.168.1.1   0.0.0.0         eth0    # 默认路由
192.168.1.0     0.0.0.0       255.255.255.0   eth0    # 直连网络
10.0.0.0        192.168.1.254 255.0.0.0       eth0    # 静态路由
```

#### 🔄 **路由协议分类**

##### **内部网关协议（IGP）**

| 协议      | 类型     | 特点                | 应用场景   |
| --------- | -------- | ------------------- | ---------- |
| **RIP**   | 距离矢量 | 简单，最大跳数 15   | 小型网络   |
| **OSPF**  | 链路状态 | 快速收敛，支持 VLSM | 企业网络   |
| **EIGRP** | 混合型   | Cisco 专有，高效    | Cisco 网络 |

##### **外部网关协议（EGP）**

- **BGP**: 互联网骨干网络使用，支持策略路由

#### 🏠 **实际应用场景**

##### **家庭网络路由**

```
互联网 → ISP路由器 → 家用路由器 → 家庭设备
                    ↓
                 默认网关: 192.168.1.1
                 DHCP范围: 192.168.1.100-200
```

##### **企业网络路由**

```
企业总部网络: 10.1.0.0/16
    ↓
分支机构连接: VPN隧道
    ↓
分支网络: 10.2.0.0/16, 10.3.0.0/16
```

---

### 5. ARP 协议

#### 🔍 **什么是 ARP？**

ARP（Address Resolution Protocol）用于将 IP 地址解析为 MAC 地址，是网络层与链路层之间的桥梁。

#### 🔄 **ARP 工作过程**

```
步骤1: PC1想访问PC2 (IP: 192.168.1.100)
      ↓
步骤2: 检查ARP缓存表
      ↓
步骤3: 如果没有，发送ARP请求广播
      "谁的IP是192.168.1.100? 请告诉00:11:22:33:44:55"
      ↓
步骤4: PC2收到请求，回复ARP响应
      "192.168.1.100是我的，我的MAC是AA:BB:CC:DD:EE:FF"
      ↓
步骤5: PC1更新ARP缓存，开始通信
```

#### 🛠️ **ARP 实际操作**

##### **查看 ARP 缓存表**

```bash
# Linux/macOS
arp -a
ip neighbor show

# Windows
arp -a

# 输出示例
192.168.1.1 (192.168.1.1) at 00:11:22:33:44:55 [ether] on eth0
192.168.1.100 (192.168.1.100) at aa:bb:cc:dd:ee:ff [ether] on eth0
```

##### **手动管理 ARP 表**

```bash
# 添加静态ARP条目
arp -s 192.168.1.100 aa:bb:cc:dd:ee:ff

# 删除ARP条目
arp -d 192.168.1.100

# 清空ARP缓存
ip -s -s neigh flush all
```

#### ⚠️ **ARP 安全问题**

##### **ARP 欺骗攻击**

```
正常情况:
PC → 网关(192.168.1.1: 00:11:22:33:44:55)

ARP欺骗:
攻击者发送虚假ARP: "192.168.1.1的MAC是aa:bb:cc:dd:ee:ff"
PC → 攻击者(192.168.1.1: aa:bb:cc:dd:ee:ff) → 网关
```

##### **防护措施**

```bash
# 静态ARP绑定
arp -s 192.168.1.1 00:11:22:33:44:55

# 网络监控
tcpdump -i eth0 arp

# 交换机端口安全
switchport port-security mac-address sticky
```

---

### 6. ICMP 协议

#### 📡 **什么是 ICMP？**

ICMP（Internet Control Message Protocol）是网络层的控制协议，用于错误报告和网络诊断。

#### 📊 **ICMP 消息类型**

##### **查询消息**

| 类型         | 代码 | 功能           | 应用      |
| ------------ | ---- | -------------- | --------- |
| **回送请求** | 8    | 测试连通性     | ping 命令 |
| **回送应答** | 0    | 响应 ping 请求 | ping 回复 |

##### **错误消息**

| 类型           | 代码 | 功能         | 应用场景             |
| -------------- | ---- | ------------ | -------------------- |
| **目标不可达** | 3    | 无法到达目标 | 网络/主机/端口不可达 |
| **超时**       | 11   | TTL 超时     | traceroute 命令      |
| **重定向**     | 5    | 路由优化     | 更好的路径提示       |

#### 🔧 **ICMP 实际应用**

##### **ping 命令详解**

```bash
# 基本ping
ping 8.8.8.8

# 指定次数
ping -c 4 google.com

# 设置包大小
ping -s 1000 192.168.1.1

# 连续ping
ping -t google.com    # Windows
ping google.com       # Linux持续
```

##### **traceroute 路径追踪**

```bash
# Linux
traceroute google.com

# Windows
tracert google.com

# 输出示例
1  192.168.1.1 (192.168.1.1)  1.234 ms
2  10.0.0.1 (10.0.0.1)  15.678 ms
3  203.208.60.1 (203.208.60.1)  25.456 ms
...
```

##### **网络诊断实例**

```bash
# 检查本地连接
ping 127.0.0.1

# 检查网关连接
ping 192.168.1.1

# 检查DNS解析
ping google.com
nslookup google.com

# 检查路径
traceroute 8.8.8.8
```

---

### 7. DHCP 动态地址分配

#### 🔄 **DHCP 工作过程（DORA）**

```
客户端启动
    ↓
1. Discover: 广播寻找DHCP服务器
    "有DHCP服务器吗？我需要IP地址"
    ↓
2. Offer: 服务器提供IP地址
    "这里有个192.168.1.100可以给你"
    ↓
3. Request: 客户端请求使用
    "我要使用192.168.1.100"
    ↓
4. Acknowledge: 服务器确认分配
    "好的，192.168.1.100分配给你了"
```

#### ⚙️ **DHCP 配置示例**

##### **DHCP 服务器配置**

```bash
# /etc/dhcp/dhcpd.conf
subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.100 192.168.1.200;
    option domain-name-servers 8.8.8.8, 8.8.4.4;
    option routers 192.168.1.1;
    option broadcast-address 192.168.1.255;
    default-lease-time 600;
    max-lease-time 7200;
}
```

##### **客户端 DHCP 配置**

```bash
# 请求新IP地址
dhclient eth0

# 释放当前IP
dhclient -r eth0

# 查看租约信息
cat /var/lib/dhcp/dhclient.leases
```

---

### 8. NAT 网络地址转换

#### 🔄 **NAT 工作原理**

NAT 解决了 IPv4 地址不足的问题，允许多个私有地址共享一个公网地址。

```
内网设备访问互联网:
192.168.1.100:1234 → NAT路由器 → 203.0.113.1:5678 → 互联网

NAT转换表:
内网地址:端口        公网地址:端口
192.168.1.100:1234  203.0.113.1:5678
192.168.1.101:2345  203.0.113.1:5679
192.168.1.102:3456  203.0.113.1:5680
```

#### 🏠 **家庭网络 NAT 实例**

```
互联网 (公网IP: 203.0.113.1)
    ↓
家用路由器 (NAT设备)
    ↓ (私网IP: 192.168.1.0/24)
├─ 电脑: 192.168.1.100
├─ 手机: 192.168.1.101
├─ 平板: 192.168.1.102
└─ 智能电视: 192.168.1.103
```

### 10. IPv6 简介

#### 🌐 **为什么需要 IPv6？**

- **地址空间**: IPv4 (43 亿) vs IPv6 (340 万亿亿亿亿)
- **地址格式**: 32 位 vs 128 位
- **配置**: DHCP vs 自动配置
- **安全**: 可选 vs 内置 IPSec

#### 📍 **IPv6 地址格式**

```
完整格式: 2001:0db8:85a3:0000:0000:8a2e:0370:7334
简化格式: 2001:db8:85a3::8a2e:370:7334

地址类型:
- 单播地址: 一对一通信
- 组播地址: 一对多通信
- 任播地址: 一对最近通信
```

---

### 📚 学习总结

#### ✅ **核心要点回顾**

1. **网络层作用**: 实现主机到主机的通信
2. **IP 地址**: 网络层的逻辑地址系统
3. **路由选择**: 在多个路径中选择最佳路径
4. **ARP 协议**: IP 地址到 MAC 地址的映射
5. **ICMP 协议**: 网络诊断和错误报告
6. **实际应用**: DHCP、NAT、子网划分

#### 🎯 **实践建议**

1. **动手实验**:

   - 配置静态 IP 地址和路由
   - 使用 ping 和 traceroute 诊断网络
   - 观察 ARP 表的变化

2. **工具掌握**:

   - 网络命令: ping, traceroute, netstat
   - 配置命令: ifconfig, ip, route
   - 监控工具: wireshark, tcpdump

3. **案例分析**:
   - 家庭网络的 IP 地址分配
   - 企业网络的子网规划
   - 网络故障的排查流程

#### 🔍 **深入学习方向**

- **路由协议**: OSPF, BGP 详细机制
- **网络安全**: VPN, 防火墙配置
- **IPv6 技术**: 过渡技术和新特性
- **SDN 技术**: 软件定义网络

---

> **💡 学习提示**: 网络层是整个网络通信的核心，理解其工作原理对于网络工程师和系统管理员都非常重要。建议结合实际的网络环境进行学习和实验，这样能更好地理解理论知识的实际应用。

#### 99. quiz

##### 1. 为什么本地地址是 127.0.0.1?

127.0.0.1 是一个特殊的 IP 地址，被称为本地回环地址或 localhost。这个地址用于在计算机网络中表示当前设备，也就是说，当一个程序需要与运行在同一设备上的另一个程序通信时，可以使用这个地址。

这个地址之所以被选择为本地回环地址，是因为在 IPv4 地址空间中，127.0.0.0/8（也就是从 127.0.0.0 到 127.255.255.255 的所有地址）都被保留为本地回环地址。这是由互联网工程任务组（IETF）在 RFC 3330 中规定的。

其中，127.0.0.1 是最常用的本地回环地址，但实际上，任何从 127.0.0.0 到 127.255.255.255 的地址都可以作为本地回环地址使用。

使用本地回环地址的好处是，可以在没有网络连接的情况下测试网络应用，因为所有发送到本地回环地址的数据包都会被操作系统立即返回，不会真正发送到网络上。

##### 2. 那如果 ARP 缓存的条目没有达到生命周期的末尾,但是目标设备的 IP 地址又发生了变换,会怎么样呢?

如果 ARP 缓存的条目没有达到生命周期的末尾,但是目标设备的 IP 地址又发生了变换,那么在 ARP 缓存过期之前,设备可能会继续使用旧的 IP 地址和 MAC 地址对应关系进行通信,这可能导致通信失败.

在实际的网络环境中,这种情况很少发生,因为 IP 地址通常是静态的,或者在动态分配时,其生命周期通常远大于 ARP 缓存的生命周期.

如果确实出现了这种情况,可以通过手动清除 ARP 缓存来解决.大多数操作系统都提供了清除 ARP 缓存的命令,例如在 Windows 中可以使用`arp -d`命令,在 Linux 中可以使用`ip -s -s neigh flush all`命令.这样可以强制设备发送新的 ARP 请求,获取最新的 IP 地址和 MAC 地址对应关系.

##### 3. IP 不是可以动态的吗?如果是动态 IP 那不就 ARP 缓存会出现频繁过期吗

是的,IP 地址可以是动态的,这通常在 DHCP(动态主机配置协议)环境中发生.在这种情况下,设备的 IP 地址可能会在一段时间后改变.

然而,ARP 缓存的生命周期通常比较短,通常在几分钟到几个小时之间.这意味着即使 IP 地址改变,ARP 缓存也会在短时间内过期并更新.因此,即使在动态 IP 环境中,ARP 缓存也能有效地维护 IP 地址和 MAC 地址之间的映射.

另外,当设备的 IP 地址改变时,设备通常会发送一个 ARP 通告(ARP Announcement),这是一个特殊的 ARP 响应,用于更新其他设备的 ARP 缓存.这样,即使 ARP 缓存还没有过期,其他设备也能立即知道新的 IP 地址和 MAC 地址的对应关系.

##### 4. arp 协议有什么用?不是只能解决在局域网的通信吗?如果两台通信设备不在同一个局域网,怎么办?

ARP 协议的主要作用是在同一局域网内,将设备的 IP 地址解析为对应的 MAC 地址,从而使设备能够通过 IP 地址进行通信.这是因为在局域网中,设备之间的通信实际上是通过 MAC 地址进行的,而 IP 地址只是用于寻址的.

如果两台通信设备不在同一个局域网内,那么它们之间的通信就需要通过路由器进行.在这种情况下,发送设备会将数据发送到其默认网关(通常是路由器),然后由路由器根据目标 IP 地址将数据转发到正确的网络.在这个过程中,ARP 协议仍然起到了重要的作用,因为发送设备需要知道其默认网关的 MAC 地址,而这就是通过 ARP 协议来获取的.

因此,虽然 ARP 协议只能在局域网内解析 IP 地址和 MAC 地址,但它在整个网络通信过程中仍然起到了关键的作用.

##### 5. 对于一个新加入设备,怎么知道谁是网关?

新加入的设备通常通过 DHCP(动态主机配置协议)来获取网络配置信息,包括默认网关的 IP 地址.当设备连接到网络时,它会发送一个 DHCP 发现(DHCP Discover)消息,然后 DHCP 服务器会回应一个 DHCP 提供(DHCP Offer)消息,其中包含了网络配置信息.设备接收到这个消息后,就可以知道默认网关的 IP 地址了.

如果网络中没有 DHCP 服务器,或者设备是静态配置的,那么默认网关的 IP 地址就需要手动设置.

一旦设备知道了默认网关的 IP 地址,它就可以使用 ARP 协议来获取网关的 MAC 地址.设备会发送一个 ARP 请求,询问网关的 IP 地址对应的 MAC 地址,然后网关会回应一个 ARP 响应,其中包含了它的 MAC 地址.设备接收到这个响应后,就可以知道网关的 MAC 地址了.

这样,设备就可以通过网关与其他网络进行通信了.

##### 6. 什么是网络层分片？原因与具体实现又是什么？

网络层分片是由 IP 协议(Internet Protocol)决定的.在 IPv4 中,如果一个数据包的大小超过了链路层的最大传输单元(MTU),那么 IP 协议会在网络层进行分片,将大的数据包划分为多个小的数据包,每个小的数据包的大小都不超过 MTU.

需要注意的是,在 IPv6 中,网络层不再进行分片,而是由发送端的传输层进行分片.如果一个数据包的大小超过了 MTU,那么发送端需要在传输层将数据包划分为多个小的数据包,然后再发送.这是因为网络层分片会增加网络的复杂性和开销,因此 IPv6 设计者决定将分片的责任交给发送端.

网络层分片是指在网络层将大的数据包划分为多个小的数据包的过程.这个过程通常发生在数据包的大小超过链路层的最大传输单元(MTU)时.

为什么要进行分片呢?这是因为在链路层中,每种类型的物理介质都有一个最大传输单元(MTU),这是由物理介质的特性决定的.例如,在以太网中,MTU 的大小通常是 1500 字节.如果一个数据包的大小超过了 MTU,那么就需要在网络层进行分片,将大的数据包划分为多个小的数据包,每个小的数据包的大小都不超过 MTU. 分片的过程是在发送端进行的,接收端收到分片后,会根据分片中的信息将它们重新组装成原来的数据包.这个过程是透明的,也就是说,应用层并不知道数据包被分片和重新组装的过程.

需要注意的是,分片会增加网络的复杂性和开销,因此在设计网络应用时,应尽量避免发送过大的数据包,以减少分片的需要.

##### 7. 同一个子网下的 IP 地址为什么一般都是 192.168 开始的?

192.168.x.x 是一个专门为私有网络(如家庭和企业内部网络)预留的 IP 地址范围,由 RFC 1918 定义.这个地址范围在全球范围内可以重复使用,但在同一个网络内必须是唯一的.

除了 192.168.x.x,RFC 1918 还定义了两个其他的私有 IP 地址范围:10.x.x.x 和 172.16.x.x 到 172.31.x.x.然而,由于 192.168.x.x 的地址范围较小,足够大多数家庭和小型企业使用,因此它被广泛用作默认的私有 IP 地址范围.

当你设置一个网络设备(如路由器)为 DHCP 服务器时,它通常会默认使用 192.168.x.x 的地址范围为网络内的设备分配 IP 地址.这就是为什么同一个子网下的 IP 地址通常都是以 192.168 开始的.

**ARP** ARP 协议能实现任意网络层地址到任意物理地址的转换

##### 8. DHCP 协议是什么？使用什么端口？他的优劣？

##### 9. ping 命令使用的是什么协议？

##### 10. 路由表一般包含什么？

##### 11. 有了 mac 地址，为什么还要有 IP 地址？

MAC 地址和 IP 地址虽然都用于标识网络中的设备，但它们在网络通信中扮演的角色是不同的，因此两者都是必要的。

1. **全局唯一性**：MAC 地址是全球唯一的，它在生产时被硬编码到网络接口卡上。然而，MAC 地址只在本地网络中有意义，不能用于在全球范围内定位设备。相反，IP 地址是在全球范围内唯一的，可以用于在互联网上定位设备。
2. **路由**：IP 地址不仅标识了设备，还提供了设备的网络位置信息。IP 地址由网络部分和主机部分组成，这使得路由器可以根据 IP 地址的网络部分将数据包转发到正确的网络。而 MAC 地址没有这种网络位置信息，不能用于路由。
3. **灵活性**：IP 地址可以动态分配和更改，这使得设备可以移动到不同的网络而不需要更改硬件。而 MAC 地址是固定的，不能更改。
4. **抽象层次**：MAC 地址和 IP 地址存在于不同的网络模型层次。MAC 地址存在于数据链路层，直接与物理硬件相关。而 IP 地址存在于网络层，提供了一个从物理硬件抽象出来的地址系统，使得上层应用可以不关心底层的物理连接细节。

因此，虽然有了 MAC 地址，但我们仍然需要 IP 地址来进行全球范围的网络通信。

##### 12. 接入网络的时候，IP 地址是怎么分配的？

接入网络时，IP 地址的分配通常通过动态主机配置协议（DHCP）进行。以下是基本的步骤：

1. **DHCP 发现（DHCP Discover）**：当设备连接到网络并需要 IP 地址时，它会发送一个 DHCP 发现消息。这个消息是一个广播消息，会被网络中的所有设备接收到。
2. **DHCP 提供（DHCP Offer）**：网络中的 DHCP 服务器会接收到 DHCP 发现消息，然后从它的地址池中选择一个可用的 IP 地址。然后，DHCP 服务器会将这个 IP 地址以及其他网络配置（如子网掩码、默认网关、DNS 服务器等）封装在 DHCP 提供消息中，然后发送给请求的设备。
3. **DHCP 请求（DHCP Request）**：设备接收到 DHCP 提供消息后，会从中选择一个 DHCP 服务器（如果有多个的话），然后向这个服务器发送 DHCP 请求消息，请求使用提供的 IP 地址。
4. **DHCP 应答（DHCP Acknowledgement）**：DHCP 服务器接收到 DHCP 请求消息后，会发送一个 DHCP 应答消息，确认设备可以使用提供的 IP 地址。

以上就是接入网络时 IP 地址的分配过程。需要注意的是，分配的 IP 地址通常有一个租期，当租期到期后，设备需要重新请求 IP 地址。
